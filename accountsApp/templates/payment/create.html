{% extends "layout/base.html" %}
{% block title %}Create Payment{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
        Create Payment
    </div>

    <div class="card-body">
        <form method="POST">
            {% csrf_token %}

            <!-- CLIENT -->
            <div class="mb-3">
                <label class="form-label">Client</label>
                <select name="client" class="form-select" required>
                    <option value="">Select Client</option>
                    {% for client in clients %}
                        <option value="{{ client.id }}">{{ client.name }} ({{ client.company.name }})</option>
                    {% endfor %}
                </select>
            </div>

            <!-- PAYMENT MODE -->
            <div class="mb-3">
                <label class="form-label">Payment Mode</label>
                <select name="payment_mode" id="payment_mode" class="form-select" required>
                    <option value="cash">Cash</option>
                    <option value="cheque">Cheque</option>
                </select>
            </div>

            <!-- BANK -->
            <div class="mb-3">
                <label class="form-label">Bank</label>
                <select name="bank" id="bank_select" class="form-select" required>
                    {% for bank in banks %}
                        <option value="{{ bank.id }}"
                            {% if bank.name|lower == 'cash' %}data-cash="1"{% endif %}>
                            {{ bank.name }}
                        </option>
                    {% endfor %}
                </select>

                <!-- WARNINGS -->
                <small id="cashWarning" class="text-danger d-none">
                    Cash payment must use <strong>Cash</strong> bank only.
                </small>

                <small id="chequeWarning" class="text-danger d-none">
                    Cheque payment cannot use <strong>Cash</strong> bank.
                </small>
            </div>

            <!-- AMOUNT -->
            <div class="mb-3">
                <label class="form-label">Amount</label>
                <input type="number"
                       step="0.01"
                       name="amount"
                       class="form-control"
                       required>
            </div>

            <!-- DATE -->
            <div class="mb-3">
                <label class="form-label">Payment Date</label>
                <input type="date"
                       name="payment_date"
                       class="form-control"
                       required>
            </div>

            <!-- ACTIONS -->
            <button class="btn btn-success">Save</button>
            <a href="{% url 'payment_index' %}" class="btn btn-secondary">
                Back
            </a>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {

    const paymentMode = document.getElementById('payment_mode');
    const bankSelect = document.getElementById('bank_select');
    const cashWarning = document.getElementById('cashWarning');
    const chequeWarning = document.getElementById('chequeWarning');

    function getSelectedBankIsCash() {
        const option = bankSelect.options[bankSelect.selectedIndex];
        return option.dataset.cash === "1";
    }

    function validate() {
        cashWarning.classList.add('d-none');
        chequeWarning.classList.add('d-none');

        const isCashBank = getSelectedBankIsCash();

        if (paymentMode.value === 'cash' && !isCashBank) {
            cashWarning.classList.remove('d-none');
        }

        if (paymentMode.value === 'cheque' && isCashBank) {
            chequeWarning.classList.remove('d-none');
        }
    }

    paymentMode.addEventListener('change', function () {
        // Auto-select Cash bank when Cash mode
        if (this.value === 'cash') {
            [...bankSelect.options].forEach(o => {
                if (o.dataset.cash === "1") {
                    bankSelect.value = o.value;
                }
            });
        }
        validate();
    });

    bankSelect.addEventListener('change', validate);
});
</script>
{% endblock %}
