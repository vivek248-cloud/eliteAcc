{% extends "layout/base.html" %}
{% block title %}spending{% endblock %}

{% block content %}
<h4>Spending</h4>

<form method="get" class="row g-3 mb-4 align-items-end">

    <!-- üë§ CLIENT -->
    <div class="col-md-3">
        <label class="form-label">Client</label>
        <select name="client" class="form-select">
            <option value="">All Clients</option>
            {% for c in clients %}
                <option value="{{ c.id }}"
                    {% if selected_client == c.id|stringformat:"s" %}selected{% endif %}>
                    {{ c.name }}
                    {% if c.company %}
                        ({{ c.company.name }})
                    {% endif %}
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- üè∑ CATEGORY -->
    <div class="col-md-3">
        <label class="form-label">Category</label>
        <select name="category" class="form-select" id="categorySelect">
            <option value="">All Categories</option>
            {% for cat in categories %}
                <option value="{{ cat.id }}"
                    data-name="{{ cat.name|lower }}"
                    {% if selected_category == cat.id|stringformat:"s" %}selected{% endif %}>
                    {{ cat.name }}
                </option>
            {% endfor %}
        </select>
    </div>



    <!-- üë∑ WORKER (NEW) -->
    <div class="col-md-3 d-none" id="workerFilter">
        <label class="form-label">Worker</label>
        <select name="worker" class="form-select" id="workerSelect">
            <option value="">All Workers</option>
            {% for w in workers %}
                <option value="{{ w.id }}"
                    {% if selected_worker == w.id|stringformat:"s" %}selected{% endif %}>
                    {{ w.name }}
                </option>
            {% endfor %}
        </select>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', function () {

        const categorySelect = document.getElementById('categorySelect');
        const workerFilter = document.getElementById('workerFilter');
        const workerSelect = document.getElementById('workerSelect');

        function toggleWorkerFilter() {
            const selectedOption = categorySelect.options[categorySelect.selectedIndex];
            const categoryName = selectedOption?.dataset.name || '';

            if (categoryName === 'salary') {
                workerFilter.classList.remove('d-none');
            } else {
                workerFilter.classList.add('d-none');
                workerSelect.value = ''; // reset worker when hidden
            }
        }

        // On change
        categorySelect.addEventListener('change', toggleWorkerFilter);

        // On page load (important!)
        toggleWorkerFilter();
    });
    </script>


    <!-- üí≥ SPEND MODE (NEW) -->
    <div class="col-md-2">
        <label class="form-label">Spend Mode</label>
        <select name="spend_mode" id="spendModeSelect" class="form-select">
            <option value="">All</option>
            <option value="cash" {% if selected_spend_mode == 'cash' %}selected{% endif %}>Cash</option>
            <option value="cheque" {% if selected_spend_mode == 'cheque' %}selected{% endif %}>Cheque</option>
        </select>
    </div>

    <!-- üè¶ BANK (NEW) -->
    <div class="col-md-3">
        <label class="form-label">Bank</label>
        <select name="bank" id="bankSelect" class="form-select">
            <option value="">All Banks</option>

            {% if cash_bank %}
                <option value="{{ cash_bank.id }}"
                        data-type="cash"
                        {% if selected_bank == cash_bank.id|stringformat:"s" %}selected{% endif %}>
                    {{ cash_bank.name }}
                </option>
            {% endif %}

            {% for b in banks %}
                <option value="{{ b.id }}"
                        data-type="cheque"
                        {% if selected_bank == b.id|stringformat:"s" %}selected{% endif %}>
                    {{ b.name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- üìÖ START DATE -->
    <div class="col-md-2">
        <label class="form-label">Start Date</label>
        <input type="date" name="start_date"
               value="{{ start_date }}" class="form-control">
    </div>

    <!-- üìÖ END DATE -->
    <div class="col-md-2">
        <label class="form-label">End Date</label>
        <input type="date" name="end_date"
               value="{{ end_date }}" class="form-control">
    </div>

    <!-- üîò ACTIONS -->
    <div class="col-md-2 d-flex gap-2">
        <button class="btn btn-primary w-100">Apply</button>
        <a href="{% url 'expense_index' %}" class="btn btn-secondary w-100">
            Reset
        </a>
    </div>

</form>


<div class="d-flex justify-content-center" style="position: sticky; top: 80px; z-index: 1050;">
    <div class="shadow-lg border-0 rounded-pill px-4 py-2 d-inline-flex align-items-center animate__animated animate__fadeInDown" 
         style="background: rgba(13, 110, 253, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2) !important;">
        
        <div class="bg-white rounded-circle d-flex align-items-center justify-content-center me-3" 
             style="width: 32px; height: 32px;">
            <i class="bi bi-calculator-fill text-primary" style="font-size: 1rem;"></i>
        </div>

        <div class="text-white">
            <span class="text-uppercase fw-bold opacity-5 me-2" style="font-size: 0.7rem; letter-spacing: 0.5px;">
                Selected Total
            </span>
            <span class="fs-5 fw-black" style="font-family: 'Monaco', monospace;">
                ‚Çπ <span id="selectedTotal">0.00</span>
            </span>
        </div>
    </div>
</div>


<a href="{% url 'expense_create' %}" class="btn btn-primary mb-3">
    + Add Spending
</a>


<a href="{% url 'expense_pdf_export' %}?{{ request.GET.urlencode }}"
   class="btn btn-danger btn-sm mb-3 ms-2 py-2 px-3 rounded-3">
    <i class="bi bi-file-earmark-pdf-fill me-1"></i>
   Export PDF
</a>

<div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
<!-- üìã TABLE -->
<table class="table table-bordered table-hover align-middle">
    <thead class="table-primary">
        <tr>
            <th>#</th>
            <th>Client</th>
            <th>Category</th>
            <th>Salary for</th> 
            <th>Description</th>
            <th>Bank</th>
            <th class="text-end">Amount</th>
            <th>Mode</th>
            <th>Date</th>
            <th>Action</th>
        </tr>
    </thead>

    <tbody>
        {% for expense in expenses %}
        <tr>
            <td>{{ forloop.counter }}</td>

            <td>{{ expense.client.name }}</td>

            <!-- üè∑ CATEGORY -->
            <td>
                {{ expense.category.name|default:"‚Äî" }}
            </td>

            <td>
                {% if expense.salary_to %}
                    <span class="fw-semibold text-primary">
                        {{ expense.salary_to.name }}
                    </span>
                {% else %}
                    ‚Äî
                {% endif %}
            </td>
            <td>{{ expense.description }}</td>

            <td class="highlight-cell3">{{ expense.bank.name|default:"Cash" }}</td>

            <td class="text-end text-danger fw-semibold highlight-cell selectable-amount" data-amount="{{ expense.amount }}"  data-col="amount">
                ‚Çπ {{ expense.amount|floatformat:2 }}
            </td>

            <td class="text-capitalize">
                {{ expense.spend_mode }}
            </td>

            <td>{{ expense.expense_date }}</td>

            <td class="d-flex gap-2">
                <a href="{% url 'expense_update' expense.id %}"
                   class="btn btn-sm btn-outline-warning">
                    Edit
                </a>

                <a href="{% url 'expense_delete' expense.id %}"
                   class="btn btn-sm btn-outline-danger">
                    Delete
                </a>
            </td>
        </tr>

        {% empty %}
        <tr>
            <td colspan="9" class="text-center text-muted">
                No expenses found
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>






</div>


<script>
document.addEventListener('DOMContentLoaded', function () {

    const filterFields = document.querySelectorAll(
        'select[name], input[name]'
    );

    function updateHighlight(el) {
        if (!el) return;

        if (el.value && el.value !== '') {
            el.classList.add('filter-active');
        } else {
            el.classList.remove('filter-active');
        }
    }

    // Initial highlight on page load
    filterFields.forEach(el => updateHighlight(el));

    // Update highlight on change / input
    filterFields.forEach(el => {
        el.addEventListener('change', () => updateHighlight(el));
        el.addEventListener('input', () => updateHighlight(el));
    });

});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {

    let total = 0;
    let isDragging = false;
    let activeColumn = null;

    const totalEl = document.getElementById('selectedTotal');

    // üß† STACK FOR UNDO
    const selectionStack = [];

    function updateTotal(amount, add = true) {
        total += add ? amount : -amount;
        totalEl.textContent = total.toFixed(2);
    }

    function selectCell(cell) {
        if (!cell.classList.contains('selected')) {
            cell.classList.add('selected');

            const amount = parseFloat(cell.dataset.amount || 0);
            updateTotal(amount, true);

            // üß† PUSH TO STACK
            selectionStack.push(cell);
        }
    }

    function unselectCell(cell) {
        if (cell.classList.contains('selected')) {
            cell.classList.remove('selected');

            const amount = parseFloat(cell.dataset.amount || 0);
            updateTotal(amount, false);
        }
    }

    document.querySelectorAll('.selectable-amount').forEach(td => {

        const column = td.dataset.col;

        // ‚ùå Disable right-click menu
        td.addEventListener('contextmenu', e => e.preventDefault());

        td.addEventListener('mousedown', function (e) {

            // ‚úÖ CTRL + RIGHT CLICK ‚Üí TOGGLE
            if (e.ctrlKey && e.button === 2) {
                e.preventDefault();

                if (this.classList.contains('selected')) {
                    unselectCell(this);

                    // ‚ùå REMOVE FROM STACK
                    const index = selectionStack.indexOf(this);
                    if (index !== -1) selectionStack.splice(index, 1);

                } else {
                    selectCell(this);
                }
            }

            // üü¢ LEFT CLICK START DRAG
            if (e.button === 0) {
                isDragging = true;
                activeColumn = column;
                selectCell(this);
            }
        });

        // üü¢ DRAG OVER SAME COLUMN
        td.addEventListener('mouseenter', function () {
            if (isDragging && column === activeColumn) {
                selectCell(this);
            }
        });

    });

    // üîö STOP DRAG
    document.addEventListener('mouseup', function () {
        isDragging = false;
        activeColumn = null;
    });

    // ‚å´ BACKSPACE ‚Üí UNDO LAST SELECTION
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Backspace') {

            // ‚ùå Prevent browser back navigation
            e.preventDefault();

            const lastCell = selectionStack.pop();
            if (lastCell) {
                unselectCell(lastCell);
            }
        }
    });

});
</script>



<script>
document.addEventListener('DOMContentLoaded', function () {

    const modeSelect = document.getElementById('spendModeSelect');
    const bankSelect = document.getElementById('bankSelect');

    function filterBanks() {
        const mode = modeSelect.value;

        Array.from(bankSelect.options).forEach(opt => {
            if (!opt.value) return; // "All Banks"

            const type = opt.dataset.type;

            if (mode === 'cash') {
                opt.hidden = type !== 'cash';
            } else if (mode === 'cheque') {
                opt.hidden = type !== 'cheque';
            } else {
                opt.hidden = false;
            }
        });

        // Reset invalid selection
        const selected = bankSelect.selectedOptions[0];
        if (selected && selected.hidden) {
            bankSelect.value = '';
        }
    }

    filterBanks(); // initial load
    modeSelect.addEventListener('change', filterBanks);
});
</script>



{% endblock %}
