{% extends "layout/base.html" %}
{% block title %}Update Spend{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header bg-warning">
        Update Spend
    </div>

    <div class="card-body">
        <form method="POST" id="expenseForm">
            {% csrf_token %}

            <!-- CLIENT -->
            <div class="mb-3">
                <label class="form-label">Client</label>
                <select name="client" class="form-select" required>
                    {% for client in clients %}
                        <option value="{{ client.id }}"
                            {% if client.id == expense.client.id %}selected{% endif %}>
                            {{ client.name }} ({{ client.company.name }})
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- SPEND MODE -->
            <div class="mb-3">
                <label class="form-label">Spend Mode</label>
                <select name="spend_mode" id="spend_mode" class="form-select" required>
                    <option value="cash"
                        {% if expense.spend_mode == 'cash' %}selected{% endif %}>
                        Cash
                    </option>
                    <option value="cheque"
                        {% if expense.spend_mode == 'cheque' %}selected{% endif %}>
                        Cheque
                    </option>
                </select>
            </div>

            <!-- BANK -->
            <div class="mb-3">
                <label class="form-label">Bank</label>
                <select name="bank" id="bank_select" class="form-select">
                    <option value="">Cash</option>
                    {% for bank in banks %}
                        <option value="{{ bank.id }}"
                            {% if expense.bank and bank.id == expense.bank.id %}selected{% endif %}>
                            {{ bank.name }}
                        </option>
                    {% endfor %}
                </select>

                <small id="cashWarning" class="text-danger d-none">
                    Bank must be <strong>Cash</strong> for cash expense.
                </small>

                <small id="chequeWarning" class="text-danger d-none">
                    Please select a <strong>bank</strong> for cheque expense.
                </small>
            </div>

            <!-- CATEGORY -->
            <div class="mb-3">
                <label class="form-label">Category</label>
                <select name="category" class="form-select" required>
                    {% for category in categories %}
                        <option value="{{ category.id }}"
                            {% if expense.category and category.id == expense.category.id %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- DESCRIPTION -->
            <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea name="description"
                          class="form-control"
                          rows="3"
                          required>{{ expense.description }}</textarea>
            </div>

            <!-- AMOUNT -->
            <div class="mb-3">
                <label class="form-label">Amount</label>
                <input type="number"
                       step="0.01"
                       name="amount"
                       value="{{ expense.amount }}"
                       class="form-control"
                       required>
            </div>

            <!-- DATE -->
            <div class="mb-3">
                <label class="form-label">Expense Date</label>
                <input type="date"
                       name="expense_date"
                       value="{{ expense.expense_date|date:'Y-m-d' }}"
                       class="form-control"
                       required>
            </div>

            <button class="btn btn-primary">
                <i class="bi bi-save"></i> Update
            </button>
            <a href="{% url 'expense_index' %}" class="btn btn-secondary">Back</a>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const spendMode = document.getElementById('spend_mode');
    const bankSelect = document.getElementById('bank_select');
    const cashWarning = document.getElementById('cashWarning');
    const chequeWarning = document.getElementById('chequeWarning');
    const form = document.getElementById('expenseForm');

    function validateSelection() {
        cashWarning.classList.add('d-none');
        chequeWarning.classList.add('d-none');

        if (spendMode.value === 'cash') {
            bankSelect.value = '';
            bankSelect.disabled = true;
        } else {
            bankSelect.disabled = false;
        }

        if (spendMode.value === 'cash' && bankSelect.value !== '') {
            cashWarning.classList.remove('d-none');
            return false;
        }

        if (spendMode.value === 'cheque' && bankSelect.value === '') {
            chequeWarning.classList.remove('d-none');
            return false;
        }

        return true;
    }

    spendMode.addEventListener('change', validateSelection);
    bankSelect.addEventListener('change', validateSelection);

    form.addEventListener('submit', function (e) {
        if (!validateSelection()) {
            e.preventDefault();
        }
    });

    // üîÅ Initial validation on page load
    validateSelection();
});
</script>

{% endblock %}
