{% extends "layout/base.html" %}
{% block title %}Clients{% endblock %}

{% block content %}
<h4 class="mb-3">Client List</h4>

<a href="{% url 'client_create' %}" class="btn btn-primary mb-3">
    + Add Client
</a>

<a href="{% url 'all_clients_statement' %}"
        class="btn  btn-warning mb-3 ms-2 rounded-3">
        All Clients Statement
</a>

<div class="card border-0 shadow-sm rounded-3 mb-4">
    <div class="card-body p-3">
        <form method="get">
            <div class="row align-items-center g-3">
                
                <div class="col-md-7">
                    <div class="d-flex align-items-center gap-2">
                        <label class="text-muted small fw-bold text-uppercase mb-0 me-2">Show:</label>
                        <div class="btn-group bg-light p-1 rounded-3" role="group" style="border: 1px solid #e9ecef;">
                            
                            <input type="radio" class="btn-check" name="expense_type" id="expense_all" 
                                   value="all" {% if expense_type == 'all' %}checked{% endif %}
                                   onchange="this.form.submit()">
                            <label class="btn btn-sm btn-outline-primary border-0 rounded-2 px-3 fw-semibold" for="expense_all">
                                All
                            </label>

                            <input type="radio" class="btn-check" name="expense_type" id="expense_business" 
                                   value="business" {% if expense_type == 'business' %}checked{% endif %}
                                   onchange="this.form.submit()">
                            <label class="btn btn-sm btn-outline-primary border-0 rounded-2 px-3 fw-semibold" for="expense_business">
                                Business
                            </label>

                            <input type="radio" class="btn-check" name="expense_type" id="expense_personal" 
                                   value="personal" {% if expense_type == 'personal' %}checked{% endif %}
                                   onchange="this.form.submit()">
                            <label class="btn btn-sm btn-outline-primary border-0 rounded-2 px-3 fw-semibold" for="expense_personal">
                                Personal
                            </label>
                        </div>
                        
                        <noscript>
                            <button class="btn btn-sm btn-dark ms-2 rounded-2 px-3">Apply</button>
                        </noscript>
                    </div>
                </div>

                <div class="col-md-5">
                    <div class="d-flex flex-wrap justify-content-md-end gap-3 text-muted" style="font-size: 0.75rem;">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-wallet2 text-success me-1"></i>
                            <span><strong>Total Paid:</strong> Chq + Cash</span>
                        </div>
                        <div class="d-flex align-items-center border-start ps-3">
                            <i class="bi bi-calculator text-primary me-1"></i>
                            <span><strong>Balance:</strong> Paid-Spend-Budget</span>
                        </div>
                        <div class="d-flex align-items-center border-start ps-3">
                            <i class="bi bi-exclamation-circle text-warning me-1"></i>
                            <span><strong>Yet to Pay:</strong> Total budget - Paid</span>
                        </div>
                    </div>
                </div>

            </div>
        </form>
    </div>
</div>


<div class="toast-container position-fixed top-0 end-0 p-3 mt-5">
    <div id="filterToast" class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toastBodyContent">
                </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>


<div class="table-responsive" style="max-height: 700px; overflow-y: auto;">
<table class="table table-bordered table-hover align-middle">
    <thead class="table-primary ">
        <tr>
            <th class="text-center">#</th>
            <th class="text-center">Client</th>
            <th class="text-center">Company</th>
            <th class="text-center">Project value</th>
            <th class="text-center">Total Paid</th>
            <th class="text-center">Spending</th>
            <th class="text-center">Balance</th>
            <th class="text-center">Yet to Pay</th>
            <th class="text-center">Action</th>
        </tr>
    </thead>

    <tbody>
        {% for client in clients %}
        <tr>
            <td>{{ forloop.counter }}</td>

            <td>
                <a href="{% url 'client_info' client.id %}"
                   class="fw-bold text-decoration-none">
                    {{ client.name }} 
                </a>
            </td>

            <td>{{ client.company.name }}</td>

            <!-- ðŸ’° Budget -->
            <td class="text-end budget-cell">
                â‚¹ {{ client.budget|floatformat:2 }}
            </td>

            <!-- ðŸ’µ TOTAL PAID -->
            <td class="text-end highlight-cell" >
                <span class="{% if client.total_paid < 0 %}text-danger{% else %}text-success{% endif %}">
                    â‚¹ {{ client.total_paid|floatformat:2 }}
                </span>

                {% if client.total_paid < 0 %}
                    <span
                        class="ms-1 text-danger fw-bold"
                        data-bs-toggle="tooltip"
                        data-bs-html="true"
                        title="
                            <strong>âš  Net Negative</strong><br>
                            Cheque: â‚¹ {{ client.total_cheque_payments|floatformat:2 }}<br>
                            Cash: â‚¹ {{ client.total_cash|floatformat:2 }}<br>
                            Expenses: â‚¹ {{ client.total_expenses|floatformat:2 }}
                        "
                        style="cursor:pointer;"
                    >
                        &#33;
                    </span>
                {% endif %}
            </td>

            <!-- ðŸ”´ SPENDING -->
            <td class="text-end text-warning highlight-cell fw-semibold">
                â‚¹ {{ client.total_expenses|floatformat:2 }}
            </td>



            <!-- ðŸŸ¢ BALANCE (REFUND / PENDING) -->
            <td class="text-end fw-semibold highlight-cell">
                <span class="{% if client.balance < 0 %}text-danger{% else %}text-primary{% endif %}">
                    â‚¹ {{ client.balance|floatformat:2 }}
                </span>

                {% if client.balance < 0 %}
                    <span
                        class="ms-1 text-danger fw-bold"
                        data-bs-toggle="tooltip"
                        data-bs-html="true"
                        title="
                            <strong>âœ” help</strong><br>
                            Budget: â‚¹ {{ client.budget|floatformat:2 }}<br>
                            Total Paid: â‚¹ {{ client.total_paid|floatformat:2 }}<br>
                            client yet to pay for the spend: â‚¹ {{ client.balance|floatformat:2 }}
                        "
                        style="cursor:pointer;"
                    >
                        &#33;
                    </span>
                {% endif %}
            </td>

            <!-- ðŸŸ¡ YET TO PAY -->

            <td class="text-end fw-semibold hover-trigger
                {% if client.yet_to_pay > 0 %}
                    text-warning
                {% else %}
                    text-danger
                {% endif %}"

                {% if client.yet_to_pay < 0 %}
                    data-bs-toggle="tooltip"
                    data-bs-placement="top"
                    data-highlight-budget="true"   
                    {% if client.total_expenses > client.budget %}
                        title="âš  Project value exceeded. Admin must update project budget to match expenses."
                    {% else %}
                        title="Client overpaid. Refund or adjust in next billing."
                    {% endif %}
                {% endif %}
            >
                â‚¹ {{ client.yet_to_pay|floatformat:2 }}
            </td>



            <!-- âš™ï¸ ACTIONS -->
            <td class="d-flex gap-2 justify-content-center">
                <a href="{% url 'client_update' client.id %}"
                   class="btn btn-sm btn-outline-warning">
                    Edit
                </a>
                <a href="{% url 'client_delete' client.id %}"
                   class="btn btn-sm btn-outline-danger">
                    Delete
                </a>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="9" class="text-center text-muted">
                No clients found
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>







</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    var tooltipTriggerList = [].slice.call(
        document.querySelectorAll('[data-bs-toggle="tooltip"]')
    );
    tooltipTriggerList.map(function (el) {
        return new bootstrap.Tooltip(el);
    });

    // Hover logic
    document.querySelectorAll('[data-highlight-budget="true"]').forEach(trigger => {

        const row = trigger.closest('tr');
        if (!row) return;

        const budgetCell = row.querySelector('.budget-cell');
        if (!budgetCell) return;

        trigger.addEventListener('mouseenter', () => {
            budgetCell.classList.add('budget-highlight');
        });

        trigger.addEventListener('mouseleave', () => {
            budgetCell.classList.remove('budget-highlight');
        });

    });

});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const urlParams = new URLSearchParams(window.location.search);
    const expenseType = urlParams.get('expense_type');
    
    // If no expense_type is in URL, it's effectively "all" on first load, 
    // but usually, we only show the toast after a user interacts with the filter.
    if (expenseType) {
        const toastEl = document.getElementById('filterToast');
        const toastBody = document.getElementById('toastBodyContent');
        let message = "";
        let bgColor = "";
        let icon = "";

        switch (expenseType) {
            case 'business':
                message = "Showing <strong>Business</strong> expenses only.";
                bgColor = "bg-primary"; // Blue
                icon = "bi-briefcase-fill";
                break;
            case 'personal':
                message = "Note: The balance shown is filtered for <strong>Personal</strong> expenses.";
                bgColor = "bg-danger"; // Red
                icon = "bi-house-heart-fill";
                break;
            case 'all':
                message = "Showing <strong>All</strong> transaction balances.";
                bgColor = "bg-success"; // Black/Grey
                icon = "bi-list-ul";
                break;
        }

        if (message) {
            // Apply styles and content
            toastEl.classList.add(bgColor);
            toastBody.innerHTML = `<i class="bi ${icon} me-2"></i> ${message}`;
            
            // Show the toast
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }
    }
});
</script>
{% endblock %}
