{% extends "layout/base.html" %}
{% block title %}Client Info{% endblock %}

{% block content %}
<div class="mb-3" >
    <h4>Client Info</h4>






<div class="card border-0 shadow-sm rounded-4 " style="background: #ffffff;">
    <div class="card-body p-3">
        <div class="row align-items-center g-0">
            
            <div class="col-lg-3">
                <div class="d-flex align-items-center">
                    <div class="avatar-sm rounded-circle d-flex align-items-center justify-content-center me-3" 
                         style="width: 48px; height: 48px; background: #eef2ff;">
                        <i class="bi bi-person-badge text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="fw-black text-dark mb-0" style="letter-spacing: -0.5px; font-size: 1.25rem;">{{ client.name }}</h5>
                        <p class="text-muted small mb-0 d-flex align-items-center">
                            <i class="bi bi-building me-1"></i> {{ client.company.name }}
                        </p>
                    </div>
                </div>
            </div>

            <div class="col-lg-2 text-center">
                <span class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem; letter-spacing: 0.5px;">Project Value</span>
                <h5 class="fw-bold mt-1 mb-0" style="color: #2d3436;">‚Çπ {{ client.budget|floatformat:0 }}</h5>
            </div>

            <div class="col-lg-2 text-center">
                <span class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem; letter-spacing: 0.5px;">Total Paid</span>
                <h5 class="fw-bold mt-1 mb-0" style="color: #10ac84;">‚Çπ {{ client.total_paid|floatformat:0 }}</h5>
            </div>

            <div class="col-lg-3 text-center">
                <span class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem; letter-spacing: 0.5px;">Net Balance</span>
                <div class="d-flex align-items-center justify-content-center mt-1">
                    <h5 class="fw-bold mb-0 {% if client.balance < 0 %}text-danger{% else %}text-primary{% endif %}">
                        ‚Çπ {{ client.balance|floatformat:0 }}
                    </h5>
                    {% if client.balance < 0 %}
                        <span class="badge bg-danger bg-opacity-10 text-danger ms-2 rounded-pill" style="font-size: 0.6rem; padding: 0.3em 0.7em;">OVER SPEND</span>
                    {% else %}
                        <span class="badge bg-success bg-opacity-10 text-success ms-2 rounded-pill" style="font-size: 0.6rem; padding: 0.3em 0.7em;">PROFITABLE</span>
                    {% endif %}
                </div>
            </div>

            <div class="col-lg-2 text-end pe-3 border-start">
                <span class="text-uppercase text-muted fw-bold" style="font-size: 0.65rem; letter-spacing: 0.5px;">
                    Remaining <i class="bi bi-question-circle ms-1" style="font-size: 0.6rem;"></i>
                </span>
                <h5 class="fw-bold mt-1 mb-0 {% if client.yet_to_pay > 0 %}text-warning{% else %}text-success{% endif %}" style="font-size: 1.4rem;">
                    ‚Çπ{{ client.yet_to_pay|floatformat:0 }}
                </h5>
                <div class="mt-1">
                    {% if client.yet_to_pay > 0 %}
                        <span class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25 rounded-pill" style="font-size: 0.55rem; padding: 0.25em 0.8em;">PENDING</span>
                    {% elif client.yet_to_pay < 0 %}
                        <span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25 rounded-pill" style="font-size: 0.55rem; padding: 0.25em 0.8em;">OVERPAID</span>
                    {% else %}
                        <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-pill" style="font-size: 0.55rem; padding: 0.25em 0.8em;">CLEARED</span>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>
</div>
    
    <div class="progress rounded-0 shadow-sm" style="height: 10px; cursor: help;" 
        data-bs-toggle="tooltip" 
        data-bs-html="true" 
        data-bs-placement="top"
        title="
            <div class='p-1'>
                <div class='d-flex justify-content-between gap-4'>
                    <span>Spent:</span> 
                    <strong>‚Çπ {{ client.total_expenses|floatformat:0 }}</strong>
                </div>
                <div class='d-flex justify-content-between gap-4'>
                    <span>Budget:</span> 
                    <strong>‚Çπ {{ client.budget|floatformat:0 }}</strong>
                </div>
                <hr class='my-1 border-white opacity-25'>
                <div class='text-center'>
                    <strong>{% widthratio client.total_expenses client.budget 100 %}% Consumed</strong>
                </div>
            </div>
        ">
        
        <div class="progress-bar {% if client.total_expenses > client.budget %}bg-danger{% else %}bg-primary{% endif %} progress-bar-striped progress-bar-animated" 
            role="progressbar" 
            style="width: {% widthratio client.total_expenses client.budget 100 %}% ; border-radius: 20px;" 
            aria-valuenow="{{ client.total_expenses }}" 
            aria-valuemin="0" 
            aria-valuemax="{{ client.budget }}">
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        });
    </script>
</div>

<div class="d-flex justify-content-center" style="position: sticky; top: 80px; z-index: 1050;">
    <div class="shadow-lg border-0 rounded-pill px-4 py-2 d-inline-flex align-items-center animate__animated animate__fadeInDown" 
         style="background: rgba(13, 110, 253, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2) !important;">
        
        <div class="bg-white rounded-circle d-flex align-items-center justify-content-center me-3" 
             style="width: 32px; height: 32px;">
            <i class="bi bi-calculator-fill text-primary" style="font-size: 1rem;"></i>
        </div>

        <div class="text-white">
            <span class="text-uppercase fw-bold opacity-5 me-2" style="font-size: 0.7rem; letter-spacing: 0.5px;">
                Selected Total
            </span>
            <span class="fs-5 fw-black" style="font-family: 'Monaco', monospace;">
                ‚Çπ <span id="selectedTotal">0.00</span>
            </span>
        </div>
    </div>
</div>

<h6 class="fw-bold mb-3 mt-3"><i class="bi bi-filter-circle me-2"></i>Payment Filters</h6>

<form method="get" class="row g-2 mb-4">

    <!-- üë§ PAYMENT MODE -->
    <div class="col-md-3">
        <label class="form-label">Payment Mode</label>
        <select name="payment_mode" class="form-select">
            <option value="">All</option>
            <option value="cash" {% if payment_mode == 'cash' %}selected{% endif %}>Cash</option>
            <option value="cheque" {% if payment_mode == 'cheque' %}selected{% endif %}>Cheque</option>
        </select>
    </div>

    <!-- üìÖ START DATE -->
    <div class="col-md-3">
        <label class="form-label">Start Date</label>
        <input type="date"
               name="payment_start_date"
               value="{{ payment_start_date }}"
               class="form-control">
    </div>

    <!-- üìÖ END DATE -->
    <div class="col-md-3">
        <label class="form-label">End Date</label>
        <input type="date"
               name="payment_end_date"
               value="{{ payment_end_date }}"
               class="form-control">
    </div>

    <!-- üîò ACTIONS -->
    <div class="col-md-3 d-flex gap-2 align-items-end">
        <button class="btn btn-primary w-100">Apply</button>

        <!-- üîÑ RESET PAYMENT FILTERS -->
        <a href="{% url 'client_info' client.id %}"
           class="btn btn-secondary w-100">
            Reset
        </a>
    </div>

</form>





<!-- PAYMENTS -->
<h5>Payments</h5>
<table class="table table-bordered table-sm" style="margin-bottom: 2rem;max-height:500px;overflow-y:auto; ">
    <thead class="table-primary">
        <tr>
            <th>Date</th>
            
            <th class="text-end">Cumulative (Before)</th>
            <th class="text-end">Amount Paid (Now)</th>
            <th class="text-end">Remaining (After)</th>
            <th>Mode</th>
            <th>Bank</th>
        </tr>
    </thead>

    <tbody>
        {% for p in payments %}
        <tr>
            <td>{{ p.date }}</td>



            <td class="text-end highlight-cell2 selectable-amount"
                data-bs-toggle="tooltip"
                title="Total paid before: ‚Çπ {{ p.before|floatformat:2 }}"
                data-amount="{{ p.before }}" data-col="before">
                ‚Çπ {{ p.before|floatformat:2 }}
            </td>



            <td class="text-end text-success fw-semibold highlight-cell2 selectable-amount"
                data-amount="{{ p.amount }}" data-col="amount">
                ‚Çπ {{ p.amount|floatformat:2 }}
            </td>

            <td class="text-end fw-semibold highlight-cell2 selectable-amount
                {% if p.remaining < 0 %}
                    text-danger
                {% else %}
                    text-primary
                {% endif %}"
                data-amount="{{ p.remaining }}" data-col="remaining">
                ‚Çπ {{ p.remaining|floatformat:2 }}
            </td>

            <td class="highlight-cell3">{{ p.mode|capfirst }}</td>
            <td class="highlight-cell3">{{ p.bank }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" class="text-center text-muted">
                No payments
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<hr>

<h6 class="fw-bold mt-3 mb-3"><i class="bi bi-filter-circle me-2"></i>Expense Filters</h6>

<form method="get" class="row g-2 mb-4">

    <!-- üí∏ SPEND MODE -->
    <div class="col-md-3">
        <label class="form-label">Spend Mode</label>
        <select name="spend_mode" class="form-select">
            <option value="">All</option>
            <option value="cash" {% if spend_mode == 'cash' %}selected{% endif %}>Cash</option>
            <option value="cheque" {% if spend_mode == 'cheque' %}selected{% endif %}>Cheque</option>
        </select>
    </div>

    <!-- üè∑ CATEGORY -->
    <div class="col-md-3">
        <label class="form-label">Category</label>
        <select name="category" id="categorySelect" class="form-select">
            <option value="">All Categories</option>
            {% for cat in categories %}
                <option value="{{ cat.id }}"
                        data-name="{{ cat.name|lower }}"
                        {% if selected_category == cat.id|stringformat:"s" %}selected{% endif %}>
                    {{ cat.name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- üë∑ WORKER -->
    <div class="col-md-3 d-none" id="workerFilter">
        <label class="form-label">Worker</label>
        <select name="worker" class="form-select">
            <option value="">All Workers</option>
            {% for w in workers %}
                <option value="{{ w.id }}"
                    {% if selected_worker == w.id|stringformat:"s" %}selected{% endif %}>
                    {{ w.name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- üìÖ START DATE -->
    <div class="col-md-3">
        <label class="form-label">Start Date</label>
        <input type="date" name="start_date" value="{{ start_date }}" class="form-control">
    </div>

    <!-- üìÖ END DATE -->
    <div class="col-md-3">
        <label class="form-label">End Date</label>
        <input type="date" name="end_date" value="{{ end_date }}" class="form-control">
    </div>

    <!-- üîò ACTIONS -->
    <div class="col-md-3 d-flex gap-2 align-items-end">
        <button class="btn btn-danger w-100">Apply</button>
        <a href="{% url 'client_info' client.id %}" class="btn btn-secondary w-100">Reset</a>
    </div>

</form>

<script>
document.addEventListener('DOMContentLoaded', function () {

    const categorySelect = document.getElementById('categorySelect');
    const workerFilter = document.getElementById('workerFilter');

    function toggleWorker() {
        const option = categorySelect.options[categorySelect.selectedIndex];
        const name = option?.dataset.name || '';

        if (name === 'salary') {
            workerFilter.classList.remove('d-none');
        } else {
            workerFilter.classList.add('d-none');
        }
    }

    categorySelect.addEventListener('change', toggleWorker);

    // üîÅ On page load
    toggleWorker();
});
</script>





<!-- EXPENSES -->
<h5 class="mt-4">Expenses</h5>
<table class="table table-bordered table-sm" style="margin-bottom: 2rem;max-height:500px;overflow-y:auto;">
    <thead class="table-danger">
        <tr>
            <th>Date</th>
            <th>Worker</th>
            <th>Description</th>
            <th class="text-end">Spent Before</th>
            <th class="text-end">Spend Now</th>
            <th class="text-end">Remaining Balance</th>
            <th>Mode</th>
            <th>Bank</th>
        </tr>
    </thead>

    <tbody>
        {% for e in expenses %}
        <tr>
            <!-- DATE -->
            <td>{{ e.date }}</td>

            <!-- WORKER -->
            <td>
                {% if e.worker %}
                    <span class="fw-semibold text-primary">
                        {{ e.worker }}
                    </span>
                {% else %}
                    ‚Äî
                {% endif %}
            </td>

            <!-- DESCRIPTION -->
            <td>
                {{ e.description }}
            </td>

            <!-- SPENT BEFORE -->
            <td class="text-end text-muted selectable-amount" data-bs-toggle="tooltip" title="Total spend before ‚Çπ {{ e.before|floatformat:2 }}" data-amount="{{ e.before }}" data-col="spent_before">
                ‚Çπ {{ e.before|floatformat:2 }}
            </td>

            <!-- SPEND NOW -->
            <td class="text-end text-danger fw-semibold selectable-amount" data-bs-toggle="tooltip" title="Now spent ‚Çπ {{ e.now|floatformat:2 }}" data-amount="{{ e.now }}" data-col="spend_now">
                ‚Çπ {{ e.now|floatformat:2 }}
            </td>

            <!-- REMAINING BALANCE -->
            <td class="text-end fw-bold
                {% if e.remaining < 0 %}
                    text-danger shake
                {% else %}
                    text-primary
                {% endif %}
            selectable-amount" data-amount="{{ e.remaining }}" data-col="remaining_balance">
                ‚Çπ {{ e.remaining|floatformat:2 }}

                <i class="bi bi-info-circle ms-1"
                data-bs-toggle="tooltip"
                data-bs-html="true"
                title="
                        <div>
                            <strong>Formula</strong>
                            <hr class='my-1'>
                            Remaining = Total Paid ‚àí Total Expenses till now
                            {% if e.remaining < 0 %}
                            <div class='text-danger mt-1'>
                                ‚ö† Client has exceeded the paid amount
                            </div>
                            {% endif %}
                        </div>
                ">
                </i>

            </td>

            <!-- MODE -->
            <td>{{ e.mode|capfirst }}</td>

            <!-- BANK -->
            <td>{{ e.bank }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="7" class="text-center text-muted">
                No expenses
            </td>
        </tr>
        {% endfor %}
    </tbody>


</table>

<div class="d-flex justify-content-between">
    <a href="{% url 'client_index' %}" class="btn btn-primary mt-3 mb-3">
        ‚Üê Back to Clients
    </a>

    <a href="{% url 'client_info_pdf' client.id %}?{{ request.GET.urlencode }}"
    class="btn btn-danger mb-3 mt-3">
    üìÑ Export PDF
    </a>
</div>

</div>


<script>
document.addEventListener('DOMContentLoaded', function () {

    /* ============================
       üìÖ FILTER TYPE LOGIC
    ============================ */
    const filterType = document.querySelector('[name="filter_type"]');
    const dateInput  = document.querySelector('[name="date"]');
    const monthInput = document.querySelector('[name="month"]');
    const yearInput  = document.querySelector('[name="year"]');

    function updateDateFilters() {
        if (!filterType) return;

        const type = filterType.value;

        if (dateInput)  dateInput.disabled  = type !== 'day';
        if (monthInput) monthInput.disabled = type !== 'month';
        if (yearInput)  yearInput.disabled  = (type === 'day');
    }

    if (filterType) {
        filterType.addEventListener('change', updateDateFilters);
        updateDateFilters(); // üîÅ initial state
    }

    /* ============================
       üß© BOOTSTRAP TOOLTIPS
    ============================ */
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');

    tooltipTriggerList.forEach(function (el) {
        new bootstrap.Tooltip(el, {
            trigger: 'hover',
            boundary: 'window'
        });
    });

});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {

    const filterFields = document.querySelectorAll(
        'select[name], input[name]'
    );

    function updateHighlight(el) {
        if (!el) return;

        if (el.value && el.value !== '') {
            el.classList.add('filter-active');
        } else {
            el.classList.remove('filter-active');
        }
    }

    // Initial highlight on page load
    filterFields.forEach(el => updateHighlight(el));

    // Update highlight on change / input
    filterFields.forEach(el => {
        el.addEventListener('change', () => updateHighlight(el));
        el.addEventListener('input', () => updateHighlight(el));
    });

});
</script>



<script>
document.addEventListener('DOMContentLoaded', function () {

    let total = 0;
    let isDragging = false;
    let activeColumn = null;

    const totalEl = document.getElementById('selectedTotal');

    // üß† STACK FOR UNDO
    const selectionStack = [];

    function updateTotal(amount, add = true) {
        total += add ? amount : -amount;
        totalEl.textContent = total.toFixed(2);
    }

    function selectCell(cell) {
        if (!cell.classList.contains('selected')) {
            cell.classList.add('selected');

            const amount = parseFloat(cell.dataset.amount || 0);
            updateTotal(amount, true);

            // üß† PUSH TO STACK
            selectionStack.push(cell);
        }
    }

    function unselectCell(cell) {
        if (cell.classList.contains('selected')) {
            cell.classList.remove('selected');

            const amount = parseFloat(cell.dataset.amount || 0);
            updateTotal(amount, false);
        }
    }

    document.querySelectorAll('.selectable-amount').forEach(td => {

        const column = td.dataset.col;

        // ‚ùå Disable right-click menu
        td.addEventListener('contextmenu', e => e.preventDefault());

        td.addEventListener('mousedown', function (e) {

            // ‚úÖ CTRL + RIGHT CLICK ‚Üí TOGGLE
            if (e.ctrlKey && e.button === 2) {
                e.preventDefault();

                if (this.classList.contains('selected')) {
                    unselectCell(this);

                    // ‚ùå REMOVE FROM STACK
                    const index = selectionStack.indexOf(this);
                    if (index !== -1) selectionStack.splice(index, 1);

                } else {
                    selectCell(this);
                }
            }

            // üü¢ LEFT CLICK START DRAG
            if (e.button === 0) {
                isDragging = true;
                activeColumn = column;
                selectCell(this);
            }
        });

        // üü¢ DRAG OVER SAME COLUMN
        td.addEventListener('mouseenter', function () {
            if (isDragging && column === activeColumn) {
                selectCell(this);
            }
        });

    });

    // üîö STOP DRAG
    document.addEventListener('mouseup', function () {
        isDragging = false;
        activeColumn = null;
    });

    // ‚å´ BACKSPACE ‚Üí UNDO LAST SELECTION
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Backspace') {

            // ‚ùå Prevent browser back navigation
            e.preventDefault();

            const lastCell = selectionStack.pop();
            if (lastCell) {
                unselectCell(lastCell);
            }
        }
    });

});
</script>



{% endblock %}
