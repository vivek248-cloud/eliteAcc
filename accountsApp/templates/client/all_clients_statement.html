{% extends "layout/base.html" %}
{% block title %}All Clients Statement{% endblock %}

{% block content %}
<div class="space-y-4">

<!-- HEADER -->
<div class="flex justify-between items-center">
    <h4 class="fw-bold">All Clients Statement</h4>

    <a href="{% url 'all_client_info_pdf' %}?start_date={{ start_date }}&end_date={{ end_date }}&order={{ order }}"
       class="btn btn-danger">
        üìÑ Export PDF
    </a>
</div>

<!-- FILTERS -->
<form method="get" class="row g-2 mb-3 align-items-end">
    <div class="col-md-3">
        <label class="form-label">Type</label>
        <select name="txn_type" class="form-select">
            <option value="all" {% if txn_type == 'all' %}selected{% endif %}>All</option>
            <option value="payment" {% if txn_type == 'payment' %}selected{% endif %}>Payments</option>
            <option value="expense" {% if txn_type == 'expense' %}selected{% endif %}>Spend</option>
        </select>
    </div>

    <div class="col-md-3">
        <label class="form-label">Start Date</label>
        <input type="date" name="start_date" value="{{ start_date }}" class="form-control">
    </div>

    <div class="col-md-3">
        <label class="form-label">End Date</label>
        <input type="date" name="end_date" value="{{ end_date }}" class="form-control">
    </div>

    <div class="col-md-3">
        <label class="form-label">Order</label>
        <select name="order" class="form-select">
            <option value="new" {% if order == 'new' %}selected{% endif %}>New ‚Üí Old</option>
            <option value="old" {% if order == 'old' %}selected{% endif %}>Old ‚Üí New</option>
        </select>
    </div>

    <div class="col-md-3 d-flex gap-2">
        <button class="btn btn-primary w-100">Apply</button>
        <a href="{% url 'all_clients_statement' %}" class="btn btn-secondary w-100">Reset</a>
    </div>
</form>


<div class="d-flex justify-content-center mb-3" style="position: sticky; top: 80px; z-index: 1050;">
    <div class="shadow-lg border-0 rounded-pill px-4 py-2 d-inline-flex align-items-center animate__animated animate__fadeInDown" 
         style="background: rgba(13, 110, 253, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2) !important;">
        
        <div class="bg-white rounded-circle d-flex align-items-center justify-content-center me-3" 
             style="width: 32px; height: 32px;">
            <i class="bi bi-calculator-fill text-primary" style="font-size: 1rem;"></i>
        </div>

        <div class="text-white">
            <span class="text-uppercase fw-bold opacity-5 me-2" style="font-size: 0.7rem; letter-spacing: 0.5px;">
                Selected Total
            </span>
            <span class="fs-5 fw-black" style="font-family: 'Monaco', monospace;">
                ‚Çπ <span id="selectedTotal">0.00</span>
            </span>
        </div>
    </div>
</div>


<!-- TABLE -->
<div class="table-responsive">
<table class="table table-bordered table-sm align-middle">
<thead class="table-primary">
<tr>
    <th>Date</th>
    <th>Client</th>
    <th>Company</th>
    <th>Project Value</th>

    {% if txn_type != 'expense' %}
        <th>Previously Paid</th>
        <th>Paid Now</th>
        <th>Yet To Pay</th>
    {% endif %}

    {% if txn_type != 'payment' %}
        <th>Total Paid</th>
        <th>Spend Details</th>
        <th>Salary Info</th> 
        <th>Spend Amount</th>
        <th>Balance</th>
    {% endif %}
</tr>
</thead>


<tbody>
{% for r in rows %}
<tr>
    <td>{{ r.date }}</td>
    <td>{{ r.client }}</td>
    <td>{{ r.company }}</td>
    <td class="text-end selectable-amount" data-amount="{{ r.budget }}">‚Çπ {{ r.budget|floatformat:2 }}</td>

{% if txn_type != 'expense' %}
<td class="text-end text-muted highlight-cell selectable-amount"
    data-amount="{{ r.previous_paid }}" data-col="previous_paid">
    ‚Çπ {{ r.previous_paid|floatformat:2 }}
</td>

<td class="text-end text-success highlight-cell selectable-amount"
    data-amount="{{ r.paid_now|default:0 }}" data-col="paid_now">
    {% if r.paid_now %}‚Çπ {{ r.paid_now|floatformat:2 }}{% else %}‚Äî{% endif %}
</td>

<td class="text-end text-danger highlight-cell selectable-amount"
    data-amount="{{ r.yet_to_pay }}" data-col="yet_to_pay">
    ‚Çπ {{ r.yet_to_pay|floatformat:2 }}
</td>
{% endif %}

{% if txn_type != 'payment' %}
<td class="text-end text-muted highlight-cell selectable-amount"
    data-amount="{{ r.total_paid}}" data-col="total_paid">
    ‚Çπ {{ r.total_paid|floatformat:2 }}
</td>
<td class="highlight-cell3">{{ r.spend_detail }}</td>

<td class="highlight-cell3 text-danger fw-bold">
    {{ r.salary_info }}
</td>
<td class="text-end text-danger highlight-cell3 selectable-amount"
    data-amount="{{ r.spend_amount|default:0 }}" data-col="spend_amount">
    {% if r.spend_amount %}‚Çπ {{ r.spend_amount|floatformat:2 }}{% else %}‚Äî{% endif %}
</td>

<td class="text-end fw-bold {% if r.balance < 0 %}text-danger{% else %}text-success{% endif %}
    highlight-cell3 selectable-amount"
    data-amount="{{ r.balance }}" data-col="balance">
    ‚Çπ {{ r.balance|floatformat:2 }}
</td>
{% endif %}

</tr>
{% empty %}
<tr>
    <td colspan="12" class="text-center text-muted">No data found</td>
</tr>
{% endfor %}

{% if rows %}
<tr class="table-secondary fw-bold" style="font-size: 1.05rem; border-top: 2px solid rgba(0,0,0,.3);">

{% if txn_type == "all" %}

    <!-- 1-3 -->
    <td colspan="3" class="text-end">TOTAL</td>

    <!-- 4 Budget -->
    <td class="text-end">
        ‚Çπ {{ total_project_value|floatformat:2 }}
    </td>

    <!-- 5 Previous Paid -->
    <td></td>

    <!-- 6 Paid Now -->
    <td></td>

    <!-- 7 Yet To Pay -->
    <td class="text-end text-danger">
        ‚Çπ {{ total_yet_to_pay|floatformat:2 }}
    </td>

    <!-- 8 Total Paid -->
    <td class="text-end text-success">
        ‚Çπ {{ total_paid|floatformat:2 }}
    </td>

    <!-- 9 Spend Detail -->
    <td></td>

    <!-- 10 Salary Info -->
    <td></td>

    <!-- 11 Spend Amount -->
    <td class="text-end text-danger">
        ‚Çπ {{ total_spend|floatformat:2 }}
    </td>

    <!-- 12 Balance -->
    <td class="text-end {% if grand_balance < 0 %}text-danger{% else %}text-success{% endif %}">
        ‚Çπ {{ grand_balance|floatformat:2 }}
    </td>

{% elif txn_type == "payment" %}

    <!-- Columns: Date, Client, Company -->
    <td colspan="3" class="text-end">TOTAL</td>

    <!-- Budget -->
    <td class="text-end">
        ‚Çπ {{ total_project_value|floatformat:2 }}
    </td>

    <!-- Previous Paid -->
    <td></td>

    <!-- Paid Now -->
    <td class="text-end text-success">
        ‚Çπ {{ total_paid|floatformat:2 }}
    </td>

    <!-- Yet To Pay -->
    <td class="text-end text-danger">
        ‚Çπ {{ total_yet_to_pay|floatformat:2 }}
    </td>

{% elif txn_type == "expense" %}

    <td colspan="3" class="text-end">TOTAL</td>

    <!-- Budget -->
    <td class="text-end">
        ‚Çπ {{ total_project_value|floatformat:2 }}
    </td>

    <!-- Total Paid -->
    <td class="text-end text-success">
        ‚Çπ {{ total_paid|floatformat:2 }}
    </td>

    <!-- Empty for alignment -->
    <td></td>
    <td></td>

    <!-- Spend Amount -->
    <td class="text-end text-danger">
        ‚Çπ {{ total_spend|floatformat:2 }}
    </td>

    <!-- Balance -->
    <td class="text-end {% if grand_balance < 0 %}text-danger{% else %}text-success{% endif %}">
        ‚Çπ {{ grand_balance|floatformat:2 }}
    </td>

{% endif %}

</tr>
{% endif %}


</tbody>

</table>
</div>

</div>




<script>
document.addEventListener('DOMContentLoaded', function () {

    let total = 0;
    let isDragging = false;
    let activeColumn = null;

    const totalEl = document.getElementById('selectedTotal');

    // üß† STACK FOR UNDO
    const selectionStack = [];

    function updateTotal(amount, add = true) {
        total += add ? amount : -amount;
        totalEl.textContent = total.toFixed(2);
    }

    function selectCell(cell) {
        if (!cell.classList.contains('selected')) {
            cell.classList.add('selected');

            const amount = parseFloat(cell.dataset.amount || 0);
            updateTotal(amount, true);

            // üß† PUSH TO STACK
            selectionStack.push(cell);
        }
    }

    function unselectCell(cell) {
        if (cell.classList.contains('selected')) {
            cell.classList.remove('selected');

            const amount = parseFloat(cell.dataset.amount || 0);
            updateTotal(amount, false);
        }
    }

    document.querySelectorAll('.selectable-amount').forEach(td => {

        const column = td.dataset.col;

        // ‚ùå Disable right-click menu
        td.addEventListener('contextmenu', e => e.preventDefault());

        td.addEventListener('mousedown', function (e) {

            // ‚úÖ CTRL + RIGHT CLICK ‚Üí TOGGLE
            if (e.ctrlKey && e.button === 2) {
                e.preventDefault();

                if (this.classList.contains('selected')) {
                    unselectCell(this);

                    // ‚ùå REMOVE FROM STACK
                    const index = selectionStack.indexOf(this);
                    if (index !== -1) selectionStack.splice(index, 1);

                } else {
                    selectCell(this);
                }
            }

            // üü¢ LEFT CLICK START DRAG
            if (e.button === 0) {
                isDragging = true;
                activeColumn = column;
                selectCell(this);
            }
        });

        // üü¢ DRAG OVER SAME COLUMN
        td.addEventListener('mouseenter', function () {
            if (isDragging && column === activeColumn) {
                selectCell(this);
            }
        });

    });

    // üîö STOP DRAG
    document.addEventListener('mouseup', function () {
        isDragging = false;
        activeColumn = null;
    });

    // ‚å´ BACKSPACE ‚Üí UNDO LAST SELECTION
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Backspace') {

            // ‚ùå Prevent browser back navigation
            e.preventDefault();

            const lastCell = selectionStack.pop();
            if (lastCell) {
                unselectCell(lastCell);
            }
        }
    });

});
</script>






{% endblock %}
